
# override in order to avoid "These file are targeted separately, but appear 
# as effects of a single rule." warning.
NATIVE_ENABLED = true

if $(not $(defined-env TEST))
       OCAMLFLAGS       += -g -dtypes
       OCAML_LINK_FLAGS += -g
       OCAMLOPTFLAGS    += -inline 10
       export

BYTE_ENABLED = true

USE_OCAMLFIND = true

OCAMLPACKS[] =
	lwt
	extlib
	cryptokit

if $(not $(OCAMLFIND_EXISTS))
   eprintln(This project requires ocamlfind, but is was not found.)
   eprintln(You need to install ocamlfind and run "omake --configure".)
   exit 1

OCAML_OTHER_LIBS[] =

LIBOBJS[] =
	mq
	mq_concurrency
	mq_rabbitmq
	mq_stomp_client

OCamlLibrary(stomp, $(LIBOBJS))

toplevel: stomp.cma
	ocamlfind ocamlmktop -package $(concat \,, $(OCAMLPACKS)) \
	    -linkall -linkpkg stomp.cma -o $@

NATIVE_ENABLED = true

OCAML_LIBS[] += stomp
OCamlProgram(test_send, test_send)
OCamlProgram(test_send_rabbitmq, test_send_rabbitmq)

.PHONY: programs
programs: test_send test_send_rabbitmq

.PHONY: clean

DEFAULT = stomp.cma stomp.cmxa

.DEFAULT: $(DEFAULT)

.PHONY: all
all: toplevel $(DEFAULT)

.PHONY: doc
doc:
	ocamlfind ocamldoc -d doc -html -package $(concat \,, $(OCAMLPACKS)) \
	    *.ml *.mli

clean:
	rm -f $(filter-proper-targets $(ls R, .)) *.annot *.s
